// src/scenes/ml-prediction/index.jsx
import React, { useEffect, useState, useRef } from 'react';
import {
  Box,
  Typography,
  Card,
  CardContent,
  Grid,
  TextField,
  IconButton,
  Paper,
  Divider,
  Avatar,
  Chip,
  Button,
} from '@mui/material';
import SendIcon from '@mui/icons-material/Send';
import SmartToyIcon from '@mui/icons-material/SmartToy';
import PersonIcon from '@mui/icons-material/Person';
import LightbulbIcon from '@mui/icons-material/Lightbulb';
import BoltIcon from '@mui/icons-material/Bolt';
import TrendingUpIcon from '@mui/icons-material/TrendingUp';
import TrendingDownIcon from '@mui/icons-material/TrendingDown';
import WarningIcon from '@mui/icons-material/Warning';
import CheckCircleIcon from '@mui/icons-material/CheckCircle';
import AttachMoneyIcon from '@mui/icons-material/AttachMoney';
import { useLightState } from '../../hooks/useLightState';

const MLPrediction = () => {
  const { lightStates, lightHistory } = useLightState();
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [chatLoading, setChatLoading] = useState(false);
  const messagesEndRef = useRef(null);

  const quickQuestions = [
    "Ph√¢n t√≠ch to√†n b·ªô h·ªá th·ªëng",
    "ƒê√®n n√†o c·∫ßn b·∫£o tr√¨?",
    "T·ªëi ∆∞u h√≥a chi ph√≠ ƒëi·ªán",
    "So s√°nh hi·ªáu su·∫•t c√°c ƒë√®n",
    "D·ª± ƒëo√°n xu h∆∞·ªõng ti√™u th·ª•",
    "Ph√°t hi·ªán b·∫•t th∆∞·ªùng"
  ];

  const calculateEnergy = (lamp) => {
    const voltage = 220;
    const power = (lamp.current_a || 0) * voltage;
    const efficiency = (lamp.lamp_dim || 0) / 100;
    return ((power * efficiency) / 1000).toFixed(3);
  };

  const getLampContext = () => {
    const lamps = Object.values(lightStates);
    const onLamps = lamps.filter(l => l.lamp_state === 'ON');
    const offLamps = lamps.filter(l => l.lamp_state === 'OFF');
    
    const energyData = onLamps.map(l => ({
      id: l.node_id,
      energy: parseFloat(calculateEnergy(l)),
      brightness: l.lamp_dim,
      current: l.current_a,
      lux: l.lux
    }));

    const totalEnergy = energyData.reduce((sum, l) => sum + l.energy, 0);
    const avgBrightness = onLamps.reduce((sum, l) => sum + l.lamp_dim, 0) / (onLamps.length || 1);

    return {
      total: lamps.length,
      on: onLamps.length,
      off: offLamps.length,
      lamps: lamps.map(l => ({
        id: l.node_id,
        state: l.lamp_state,
        brightness: l.lamp_dim,
        energy: calculateEnergy(l),
        current: l.current_a,
        lux: l.lux,
        lat: l.lat,
        lng: l.lng
      })),
      totalEnergy: totalEnergy.toFixed(3),
      avgBrightness: avgBrightness.toFixed(1),
      energyData
    };
  };

  const generateSmartResponse = (question, context) => {
    const q = question.toLowerCase();
    
    // 1. Ph√¢n t√≠ch to√†n b·ªô h·ªá th·ªëng
    if (q.includes('ph√¢n t√≠ch') || q.includes('t·ªïng quan') || q.includes('h·ªá th·ªëng')) {
      const inefficientLamps = context.lamps.filter(l => 
        l.state === 'ON' && parseFloat(l.energy) > 0.012
      );
      const overbrightLamps = context.lamps.filter(l => 
        l.state === 'ON' && l.lux > 100 && l.brightness > 60
      );
      
      return `üìä **PH√ÇN T√çCH TO√ÄN B·ªò H·ªÜ TH·ªêNG**

üîã **T√¨nh tr·∫°ng ho·∫°t ƒë·ªông:**
‚Ä¢ T·ªïng s·ªë ƒë√®n: ${context.total}
‚Ä¢ ƒêang ho·∫°t ƒë·ªông: ${context.on} ƒë√®n (${((context.on/context.total)*100).toFixed(1)}%)
‚Ä¢ ƒêang t·∫Øt: ${context.off} ƒë√®n
‚Ä¢ ƒê·ªô s√°ng trung b√¨nh: ${context.avgBrightness}%

‚ö° **NƒÉng l∆∞·ª£ng:**
‚Ä¢ T·ªïng ti√™u th·ª•: ${context.totalEnergy} kWh/h
‚Ä¢ Chi ph√≠ ∆∞·ªõc t√≠nh: ${(parseFloat(context.totalEnergy) * 2500).toFixed(0)} VNƒê/gi·ªù
‚Ä¢ Ti√™u th·ª• trung b√¨nh/ƒë√®n: ${(parseFloat(context.totalEnergy) / (context.on || 1)).toFixed(3)} kWh/h

${inefficientLamps.length > 0 ? `
‚ö†Ô∏è **C·∫£nh b√°o:**
${inefficientLamps.map(l => `‚Ä¢ ƒê√®n ${l.id}: Ti√™u th·ª• cao (${l.energy} kWh/h)`).join('\n')}
` : '‚úÖ T·∫•t c·∫£ ƒë√®n ho·∫°t ƒë·ªông hi·ªáu qu·∫£!'}

${overbrightLamps.length > 0 ? `
üí° **ƒê·ªÅ xu·∫•t:**
${overbrightLamps.map(l => `‚Ä¢ ƒê√®n ${l.id}: M√¥i tr∆∞·ªùng s√°ng (${l.lux} lux), gi·∫£m ƒë·ªô s√°ng xu·ªëng 40-50%`).join('\n')}

üéØ Ti·∫øt ki·ªám ∆∞·ªõc t√≠nh: ${(overbrightLamps.length * 0.003 * 2500 * 24 * 30).toFixed(0)} VNƒê/th√°ng
` : ''}`;
    }

    // 2. B·∫£o tr√¨ v√† ph√°t hi·ªán b·∫•t th∆∞·ªùng
    if (q.includes('b·∫£o tr√¨') || q.includes('b·∫•t th∆∞·ªùng') || q.includes('l·ªói')) {
      const abnormalLamps = context.lamps.filter(l => {
        if (l.state === 'OFF') return false;
        const expectedCurrent = (l.brightness / 100) * 0.068;
        return Math.abs(l.current - expectedCurrent) > 0.01;
      });

      const highCurrentLamps = context.lamps.filter(l => 
        l.state === 'ON' && l.current > 0.07
      );

      if (abnormalLamps.length === 0 && highCurrentLamps.length === 0) {
        return `‚úÖ **H·ªÜ TH·ªêNG HO·∫†T ƒê·ªòNG B√åN H TH∆Ø·ªúNG**

üîß Kh√¥ng ph√°t hi·ªán d·∫•u hi·ªáu b·∫•t th∆∞·ªùng
üîã T·∫•t c·∫£ ƒë√®n ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh
üìÖ Khuy·∫øn ngh·ªã ki·ªÉm tra ƒë·ªãnh k·ª≥ sau 30 ng√†y`;
      }

      return `üîß **PH√ÇN T√çCH B·∫¢O TR√å**

${abnormalLamps.length > 0 ? `
‚ö†Ô∏è **C·∫ßn ki·ªÉm tra:**
${abnormalLamps.map(l => `‚Ä¢ ƒê√®n ${l.id}: D√≤ng ƒëi·ªán b·∫•t th∆∞·ªùng (${l.current.toFixed(4)}A vs d·ª± ki·∫øn ${((l.brightness / 100) * 0.068).toFixed(4)}A)`).join('\n')}

üîç Nguy√™n nh√¢n c√≥ th·ªÉ:
- B√≥ng ƒë√®n b·ªã h·ªèng
- Ballast ho·∫°t ƒë·ªông k√©m
- Ti·∫øp x√∫c ƒëi·ªán kh√¥ng t·ªët
` : ''}

${highCurrentLamps.length > 0 ? `
‚ö° **C·∫£nh b√°o qu√° t·∫£i:**
${highCurrentLamps.map(l => `‚Ä¢ ƒê√®n ${l.id}: ${(l.current * 1000).toFixed(1)}mA (v∆∞·ª£t ng∆∞·ª°ng)`).join('\n')}

üìã H√†nh ƒë·ªông khuy·∫øn ngh·ªã:
1. Ki·ªÉm tra ngay trong 24h
2. Xem x√©t thay th·∫ø thi·∫øt b·ªã
3. ƒêo ki·ªÉm ƒëi·ªán √°p ƒë·∫ßu v√†o
` : ''}

üìÖ L·ªãch b·∫£o tr√¨ ƒë·ªÅ xu·∫•t: ${new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString('vi-VN')}`;
    }

    // 3. T·ªëi ∆∞u chi ph√≠
    if (q.includes('t·ªëi ∆∞u') || q.includes('ti·∫øt ki·ªám') || q.includes('chi ph√≠')) {
      const wastefulLamps = context.lamps.filter(l => 
        l.state === 'ON' && (l.lux > 150 || (l.lux > 80 && l.brightness > 70))
      );

      const optimalBrightness = wastefulLamps.map(l => {
        let recommend = l.brightness;
        if (l.lux > 200) recommend = Math.max(30, l.brightness - 40);
        else if (l.lux > 150) recommend = Math.max(40, l.brightness - 30);
        else if (l.lux > 100) recommend = Math.max(50, l.brightness - 20);
        else recommend = Math.max(60, l.brightness - 10);
        return { ...l, recommend, saving: (l.brightness - recommend) / 100 * 0.015 };
      });

      const totalSaving = optimalBrightness.reduce((sum, l) => sum + l.saving, 0);
      const monthlySaving = totalSaving * 24 * 30 * 2500;

      if (wastefulLamps.length === 0) {
        return `üí∞ **H·ªÜ TH·ªêNG ƒê√É T·ªêI ∆ØU**

‚úÖ Kh√¥ng ph√°t hi·ªán l√£ng ph√≠ nƒÉng l∆∞·ª£ng
üìä Chi ph√≠ hi·ªán t·∫°i: ${(parseFloat(context.totalEnergy) * 24 * 30 * 2500).toFixed(0)} VNƒê/th√°ng
üéØ H·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông hi·ªáu qu·∫£`;
      }

      return `üí∞ **K·∫æ HO·∫†CH T·ªêI ∆ØU CHI PH√ç**

üéØ Ph√°t hi·ªán ${wastefulLamps.length} ƒë√®n c√≥ th·ªÉ t·ªëi ∆∞u:

${optimalBrightness.map(l => `
üìç **ƒê√®n ${l.id}:**
‚Ä¢ Hi·ªán t·∫°i: ${l.brightness}% trong m√¥i tr∆∞·ªùng ${l.lux} lux
‚Ä¢ ƒê·ªÅ xu·∫•t: ${l.recommend}% (gi·∫£m ${l.brightness - l.recommend}%)
‚Ä¢ Ti·∫øt ki·ªám: ${(l.saving * 2500 * 24 * 30).toFixed(0)} VNƒê/th√°ng
`).join('\n')}

üíµ **T·ªîNG K·∫æT:**
‚Ä¢ Ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng: ${(totalSaving * 24 * 30).toFixed(2)} kWh/th√°ng
‚Ä¢ Gi·∫£m chi ph√≠: ${monthlySaving.toFixed(0)} VNƒê/th√°ng
‚Ä¢ Gi·∫£m ph√°t th·∫£i CO2: ${(totalSaving * 24 * 30 * 0.5).toFixed(1)} kg/th√°ng

üìÖ √Åp d·ª•ng ngay ƒë·ªÉ t·ªëi ∆∞u h√≥a!`;
    }

    // 4. So s√°nh hi·ªáu su·∫•t
    if (q.includes('so s√°nh') || q.includes('hi·ªáu su·∫•t')) {
      const rankedLamps = context.lamps
        .filter(l => l.state === 'ON')
        .map(l => ({
          ...l,
          efficiency: (l.brightness / 100) / parseFloat(l.energy) || 0
        }))
        .sort((a, b) => b.efficiency - a.efficiency);

      return `üìä **SO S√ÅNH HI·ªÜU SU·∫§T C√ÅC ƒê√àN**

üèÜ **Top hi·ªáu qu·∫£ nh·∫•t:**
${rankedLamps.slice(0, 3).map((l, i) => `
${i+1}. ƒê√®n ${l.id}
   ‚Ä¢ ƒê·ªô s√°ng: ${l.brightness}%
   ‚Ä¢ Ti√™u th·ª•: ${l.energy} kWh/h
   ‚Ä¢ Hi·ªáu su·∫•t: ${(l.efficiency * 100).toFixed(1)}/100
`).join('\n')}

‚ö†Ô∏è **C·∫ßn c·∫£i thi·ªán:**
${rankedLamps.slice(-2).map(l => `
‚Ä¢ ƒê√®n ${l.id}: Hi·ªáu su·∫•t ${(l.efficiency * 100).toFixed(1)}/100
  ‚Üí ƒê·ªÅ xu·∫•t: Ki·ªÉm tra b√≥ng ƒë√®n, c√≥ th·ªÉ c·∫ßn thay th·∫ø
`).join('\n')}

üìà **Ph√¢n t√≠ch:**
‚Ä¢ Ch√™nh l·ªách hi·ªáu su·∫•t: ${((rankedLamps[0]?.efficiency || 0) / (rankedLamps[rankedLamps.length-1]?.efficiency || 1) * 100 - 100).toFixed(1)}%
‚Ä¢ ƒê√®n k√©m nh·∫•t ti√™u th·ª• nhi·ªÅu h∆°n ${(((rankedLamps[rankedLamps.length-1]?.energy || 0) / (rankedLamps[0]?.energy || 1) - 1) * 100).toFixed(1)}%`;
    }

    // 5. D·ª± ƒëo√°n xu h∆∞·ªõng
    if (q.includes('d·ª± ƒëo√°n') || q.includes('xu h∆∞·ªõng') || q.includes('t∆∞∆°ng lai')) {
      const currentCost = parseFloat(context.totalEnergy) * 24 * 30 * 2500;
      const optimizedCost = currentCost * 0.75;

      return `üìà **D·ª∞ ƒêO√ÅN XU H∆Ø·ªöNG TI√äU TH·ª§**

üìä **Th√°ng n√†y:**
‚Ä¢ D·ª± ki·∫øn: ${(parseFloat(context.totalEnergy) * 24 * 30).toFixed(2)} kWh
‚Ä¢ Chi ph√≠: ${currentCost.toFixed(0)} VNƒê
‚Ä¢ CO2: ${(parseFloat(context.totalEnergy) * 24 * 30 * 0.5).toFixed(1)} kg

üîÆ **D·ª± b√°o 3 th√°ng t·ªõi:**
‚Ä¢ N·∫øu gi·ªØ nguy√™n: ${(currentCost * 3).toFixed(0)} VNƒê
‚Ä¢ N·∫øu t·ªëi ∆∞u 25%: ${(optimizedCost * 3).toFixed(0)} VNƒê
‚Ä¢ Ti·∫øt ki·ªám: ${((currentCost - optimizedCost) * 3).toFixed(0)} VNƒê

üí° **Khuy·∫øn ngh·ªã:**
1. ƒêi·ªÅu ch·ªânh ƒë·ªô s√°ng theo th·ªùi gian th·ª±c
2. T·∫Øt ƒë√®n khi √°nh s√°ng m√¥i tr∆∞·ªùng > 200 lux
3. B·∫£o tr√¨ ƒë·ªãnh k·ª≥ m·ªói 2 th√°ng
4. Xem x√©t n√¢ng c·∫•p ƒë√®n LED hi·ªáu su·∫•t cao

üéØ M·ª•c ti√™u: Gi·∫£m 20-30% chi ph√≠ trong 6 th√°ng`;
    }

    // 6. C√¢u h·ªèi v·ªÅ ƒë√®n c·ª• th·ªÉ
    if (q.includes('ƒë√®n') && /\d+/.test(q)) {
      const lampId = q.match(/\d+/)[0];
      const lamp = context.lamps.find(l => l.id === lampId);
      
      if (!lamp) {
        return `‚ùå Kh√¥ng t√¨m th·∫•y ƒë√®n ${lampId}. 

üìã Danh s√°ch ƒë√®n hi·ªán c√≥: ${context.lamps.map(l => l.id).join(', ')}`;
      }

      const expectedCurrent = (lamp.brightness / 100) * 0.068;
      const currentDiff = Math.abs(lamp.current - expectedCurrent);
      const isAbnormal = currentDiff > 0.01;

      return `üí° **PH√ÇN T√çCH CHI TI·∫æT ƒê√àN ${lampId}**

üìä **Tr·∫°ng th√°i:**
‚Ä¢ Ngu·ªìn: ${lamp.state}
‚Ä¢ ƒê·ªô s√°ng: ${lamp.brightness}%
‚Ä¢ √Ånh s√°ng m√¥i tr∆∞·ªùng: ${lamp.lux} lux

‚ö° **ƒêi·ªán nƒÉng:**
‚Ä¢ D√≤ng ƒëi·ªán: ${lamp.current.toFixed(4)}A ${isAbnormal ? '‚ö†Ô∏è B·∫§T TH∆Ø·ªúNG' : '‚úÖ'}
‚Ä¢ D·ª± ki·∫øn: ${expectedCurrent.toFixed(4)}A
‚Ä¢ Ti√™u th·ª•: ${lamp.energy} kWh/h
‚Ä¢ Chi ph√≠/ng√†y: ${(parseFloat(lamp.energy) * 24 * 2500).toFixed(0)} VNƒê

${lamp.state === 'ON' ? `
üéØ **ƒê√°nh gi√°:**
${lamp.lux > 150 && lamp.brightness > 60 ? `‚ö†Ô∏è ƒêang l√£ng ph√≠ nƒÉng l∆∞·ª£ng
‚Üí Gi·∫£m ƒë·ªô s√°ng xu·ªëng ${Math.max(40, lamp.brightness - 30)}% ƒë·ªÉ ti·∫øt ki·ªám ${((lamp.brightness - Math.max(40, lamp.brightness - 30)) / 100 * 0.015 * 24 * 30 * 2500).toFixed(0)} VNƒê/th√°ng` : ''}
${isAbnormal ? `‚ö†Ô∏è D√≤ng ƒëi·ªán b·∫•t th∆∞·ªùng
‚Üí C·∫ßn ki·ªÉm tra b·∫£o tr√¨ trong 24-48h` : '‚úÖ Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng'}
${lamp.lux < 50 && lamp.brightness < 70 ? `üí° C√≥ th·ªÉ tƒÉng ƒë·ªô s√°ng l√™n ${lamp.brightness + 20}% ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n` : ''}
` : 'üí§ ƒê√®n ƒëang t·∫Øt'}

üìç V·ªã tr√≠: ${lamp.lat && lamp.lng ? `${lamp.lat.toFixed(4)}, ${lamp.lng.toFixed(4)}` : 'Ch∆∞a c·∫≠p nh·∫≠t'}`;
    }

    // 7. S·ªë l∆∞·ª£ng ƒë√®n
    if (q.includes('bao nhi√™u') && (q.includes('ƒë√®n') || q.includes('b·∫≠t'))) {
      return `üîÜ **T√åNH TR·∫†NG ƒê√àN HI·ªÜN T·∫†I**

üìä C√≥ ${context.on}/${context.total} ƒë√®n ƒëang b·∫≠t (${((context.on/context.total)*100).toFixed(1)}%)

${context.lamps.filter(l => l.state === 'ON').map(l => `
üí° ƒê√®n ${l.id}:
   ‚Ä¢ ƒê·ªô s√°ng: ${l.brightness}%
   ‚Ä¢ Ti√™u th·ª•: ${l.energy} kWh/h
   ‚Ä¢ Chi ph√≠/ng√†y: ${(parseFloat(l.energy) * 24 * 2500).toFixed(0)} VNƒê
`).join('\n')}

üí∞ **T·ªïng chi ph√≠ h√¥m nay:** ${(parseFloat(context.totalEnergy) * 24 * 2500).toFixed(0)} VNƒê`;
    }

    // Default
    return `üëã **XIN CH√ÄO! T√îI L√Ä TR·ª¢ L√ù AI TH√îNG MINH**

T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:

üìä **Ph√¢n t√≠ch h·ªá th·ªëng:**
‚Ä¢ "Ph√¢n t√≠ch to√†n b·ªô h·ªá th·ªëng"
‚Ä¢ "So s√°nh hi·ªáu su·∫•t c√°c ƒë√®n"
‚Ä¢ "D·ª± ƒëo√°n xu h∆∞·ªõng ti√™u th·ª•"

üîß **B·∫£o tr√¨ & Ki·ªÉm tra:**
‚Ä¢ "ƒê√®n n√†o c·∫ßn b·∫£o tr√¨?"
‚Ä¢ "Ph√°t hi·ªán b·∫•t th∆∞·ªùng"
‚Ä¢ "Tr·∫°ng th√°i ƒë√®n 3"

üí∞ **T·ªëi ∆∞u chi ph√≠:**
‚Ä¢ "T·ªëi ∆∞u h√≥a chi ph√≠ ƒëi·ªán"
‚Ä¢ "T√≠nh chi ph√≠ th√°ng n√†y"
‚Ä¢ "Ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng"

üí° H√£y th·ª≠ ƒë·∫∑t c√¢u h·ªèi c·ª• th·ªÉ ƒë·ªÉ t√¥i ph√¢n t√≠ch chi ti·∫øt h∆°n!`;
  };

  const sendMessage = async () => {
    if (!input.trim() || chatLoading) return;

    const userMessage = { role: 'user', content: input, timestamp: new Date() };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setChatLoading(true);

    setTimeout(() => {
      try {
        const context = getLampContext();
        const smartResponse = generateSmartResponse(input, context);
        
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: smartResponse,
          timestamp: new Date()
        }]);
      } catch (error) {
        console.error('Chatbot error:', error);
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: '‚ùå Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.',
          timestamp: new Date()
        }]);
      } finally {
        setChatLoading(false);
      }
    }, 500);
  };

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  useEffect(() => {
    setMessages([{
      role: 'assistant',
      content: 'üëã **Xin ch√†o! T√¥i l√† AI Assistant chuy√™n gia qu·∫£n l√Ω ƒë√®n th√¥ng minh.**\n\nT√¥i c√≥ th·ªÉ:\n‚Ä¢ üìä Ph√¢n t√≠ch to√†n b·ªô h·ªá th·ªëng\n‚Ä¢ üîß Ph√°t hi·ªán b·∫•t th∆∞·ªùng & ƒë·ªÅ xu·∫•t b·∫£o tr√¨\n‚Ä¢ üí∞ T·ªëi ∆∞u chi ph√≠ ƒëi·ªán nƒÉng\n‚Ä¢ üìà D·ª± ƒëo√°n xu h∆∞·ªõng ti√™u th·ª•\n‚Ä¢ üí° So s√°nh hi·ªáu su·∫•t c√°c ƒë√®n\n\nüéØ H√£y th·ª≠ c√°c c√¢u h·ªèi g·ª£i √Ω b√™n d∆∞·ªõi!',
      timestamp: new Date()
    }]);
  }, []);

  return (
    <Box sx={{ p: 2, bgcolor: '#0f121a', minHeight: '100vh' }}>
      <Grid container spacing={2}>
        <Grid item xs={12} lg={8}>
          <Card elevation={4} sx={{ borderRadius: 2, bgcolor: '#1e2538', height: 'calc(100vh - 32px)', display: 'flex', flexDirection: 'column' }}>
            <CardContent sx={{ p: 3, borderBottom: '1px solid #2a3142' }}>
              <Box display="flex" alignItems="center" gap={2}>
                <Avatar sx={{ bgcolor: '#6870fa', width: 48, height: 48 }}>
                  <SmartToyIcon />
                </Avatar>
                <Box>
                  <Typography variant="h5" fontWeight="bold" color="#e0e0e0">
                    AI Smart Assistant
                  </Typography>
                  <Typography variant="subtitle2" color="#b0b0b0">
                    Tr·ª£ l√Ω th√¥ng minh qu·∫£n l√Ω ƒë√®n ƒë∆∞·ªùng IoT
                  </Typography>
                </Box>
              </Box>
            </CardContent>

            <Box sx={{ flex: 1, overflowY: 'auto', p: 3, bgcolor: '#0f121a' }}>
              {messages.map((msg, idx) => (
                <Box
                  key={idx}
                  sx={{
                    display: 'flex',
                    justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start',
                    mb: 3
                  }}
                >
                  <Box
                    sx={{
                      maxWidth: '85%',
                      display: 'flex',
                      gap: 1.5,
                      flexDirection: msg.role === 'user' ? 'row-reverse' : 'row'
                    }}
                  >
                    <Avatar
                      sx={{
                        bgcolor: msg.role === 'user' ? '#6870fa' : '#4caf50',
                        width: 36,
                        height: 36
                      }}
                    >
                      {msg.role === 'user' ? <PersonIcon /> : <SmartToyIcon />}
                    </Avatar>
                    <Paper
                      elevation={3}
                      sx={{
                        p: 2,
                        bgcolor: msg.role === 'user' ? '#6870fa' : '#2a3142',
                        borderRadius: 2,
                      }}
                    >
                      <Typography
                        variant="body1"
                        sx={{
                          color: '#e0e0e0',
                          whiteSpace: 'pre-wrap',
                          wordBreak: 'break-word',
                          lineHeight: 1.6
                        }}
                      >
                        {msg.content}
                      </Typography>
                      <Typography variant="caption" sx={{ color: '#b0b0b0', mt: 1, display: 'block' }}>
                        {msg.timestamp.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}
                      </Typography>
                    </Paper>
                  </Box>
                </Box>
              ))}
              
              {chatLoading && (
                <Box sx={{ display: 'flex', gap: 1.5, mb: 3 }}>
                  <Avatar sx={{ bgcolor: '#4caf50', width: 36, height: 36 }}>
                    <SmartToyIcon />
                  </Avatar>
                  <Paper elevation={3} sx={{ p: 2, bgcolor: '#2a3142', borderRadius: 2 }}>
                    <Box display="flex" gap={0.5}>
                      <Box sx={{ width: 8, height: 8, borderRadius: '50%', bgcolor: '#6870fa', animation: 'bounce 1s infinite' }} />
                      <Box sx={{ width: 8, height: 8, borderRadius: '50%', bgcolor: '#6870fa', animation: 'bounce 1s infinite 0.2s' }} />
                      <Box sx={{ width: 8, height: 8, borderRadius: '50%', bgcolor: '#6870fa', animation: 'bounce 1s infinite 0.4s' }} />
                    </Box>
                  </Paper>
                </Box>
              )}
              <div ref={messagesEndRef} />
            </Box>

            <Divider />

            <Box sx={{ p: 2, bgcolor: '#151a27' }}>
              <Box display="flex" gap={1} mb={2}>
                <TextField
                  fullWidth
                  size="small"
                  placeholder="H·ªèi v·ªÅ h·ªá th·ªëng ƒë√®n, nƒÉng l∆∞·ª£ng, b·∫£o tr√¨..."
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                  disabled={chatLoading}
                  sx={{
                    '& .MuiOutlinedInput-root': {
                      color: '#e0e0e0',
                      bgcolor: '#0f121a',
                      '& fieldset': { borderColor: '#2a3142' },
                      '&:hover fieldset': { borderColor: '#6870fa' },
                      '&.Mui-focused fieldset': { borderColor: '#6870fa' }
                    }
                  }}
                />
                <IconButton
                  onClick={sendMessage}
                  disabled={!input.trim() || chatLoading}
                  sx={{
                    bgcolor: '#6870fa',
                    '&:hover': { bgcolor: '#5a5fd4' },
                    '&.Mui-disabled': { bgcolor: '#424242' }
                  }}
                >
                  <SendIcon sx={{ color: '#fff' }} />
                </IconButton>
              </Box>
              
              <Box display="flex" flexWrap="wrap" gap={1}>
                {quickQuestions.map((q, idx) => (
                  <Button
                    key={idx}
                    size="small"
                    variant="outlined"
                    onClick={() => setInput(q)}
                    sx={{
                      borderColor: '#6870fa',
                      color: '#6870fa',
                      textTransform: 'none',
                      fontSize: '0.75rem',
                      '&:hover': { borderColor: '#5a5fd4', bgcolor: 'rgba(104, 112, 250, 0.1)' }
                    }}
                  >
                    {q}
                  </Button>
                ))}
              </Box>
            </Box>
          </Card>
        </Grid>

        <Grid item xs={12} lg={4}>
          <Grid container spacing={2}>
            <Grid item xs={12}>
              <Card sx={{ bgcolor: '#1e2538', borderRadius: 2 }}>
                <CardContent>
                  <Box display="flex" alignItems="center" gap={1} mb={2}>
                    <BoltIcon sx={{ color: '#ffc107' }} />
                    <Typography variant="h6" fontWeight="bold" color="#e0e0e0">
                      T·ªïng quan h·ªá th·ªëng
                    </Typography>
                  </Box>
                  <Grid container spacing={2}>
                    <Grid item xs={6}>
                      <Box sx={{ p: 2, bgcolor: '#151a27', borderRadius: 1 }}>
                        <Typography variant="caption" color="#b0b0b0">ƒê√®n ho·∫°t ƒë·ªông</Typography>
                        <Typography variant="h4" fontWeight="bold" color="#4caf50">
                          {Object.values(lightStates).filter(l => l.lamp_state === 'ON').length}
                        </Typography>
                      </Box>
                    </Grid>
                    <Grid item xs={6}>
                      <Box sx={{ p: 2, bgcolor: '#151a27', borderRadius: 1 }}>
                        <Typography variant="caption" color="#b0b0b0">T·ªïng s·ªë ƒë√®n</Typography>
                        <Typography variant="h4" fontWeight="bold" color="#6870fa">
                          {Object.keys(lightStates).length}
                        </Typography>
                      </Box>
                    </Grid>
                    <Grid item xs={12}>
                      <Box sx={{ p: 2, bgcolor: '#151a27', borderRadius: 1 }}>
                        <Typography variant="caption" color="#b0b0b0">T·ªïng ti√™u th·ª•</Typography>
                        <Typography variant="h5" fontWeight="bold" color="#ffc107">
                          {getLampContext().totalEnergy} kWh/h
                        </Typography>
                      </Box>
                    </Grid>
                  </Grid>
                </CardContent>
              </Card>
            </Grid>

            <Grid item xs={12}>
              <Card sx={{ bgcolor: '#1e2538', borderRadius: 2 }}>
                <CardContent>
                  <Box display="flex" alignItems="center" gap={1} mb={2}>
                    <LightbulbIcon sx={{ color: '#4caf50' }} />
                    <Typography variant="h6" fontWeight="bold" color="#e0e0e0">
                      Danh s√°ch ƒë√®n
                    </Typography>
                  </Box>
                  <Box sx={{ maxHeight: 300, overflowY: 'auto' }}>
                    {Object.entries(lightStates).map(([nodeId, lamp]) => {
                      const isOn = lamp.lamp_state === 'ON';
                      const energy = calculateEnergy(lamp);
                      return (
                        <Box
                          key={nodeId}
                          sx={{
                            p: 1.5,
                            mb: 1,
                            bgcolor: '#151a27',
                            borderRadius: 1,
                            border: `1px solid ${isOn ? '#4caf50' : '#424242'}`,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between'
                          }}
                        >
                          <Box display="flex" alignItems="center" gap={1}>
                            <LightbulbIcon 
                              sx={{ 
                                color: isOn ? '#4caf50' : '#666',
                                fontSize: 20
                              }} 
                            />
                            <Box>
                              <Typography variant="body2" fontWeight="bold" color="#e0e0e0">
                                ƒê√®n {nodeId}
                              </Typography>
                              <Typography variant="caption" color="#b0b0b0">
                                {lamp.lamp_dim}% ‚Ä¢ {energy} kWh/h
                              </Typography>
                            </Box>
                          </Box>
                          <Chip
                            label={isOn ? 'ON' : 'OFF'}
                            size="small"
                            sx={{
                              bgcolor: isOn ? '#4caf50' : '#666',
                              color: '#fff',
                              fontSize: '0.7rem',
                              fontWeight: 'bold'
                            }}
                          />
                        </Box>
                      );
                    })}
                  </Box>
                </CardContent>
              </Card>
            </Grid>

            <Grid item xs={12}>
              <Card sx={{ bgcolor: '#1e2538', borderRadius: 2 }}>
                <CardContent>
                  <Box display="flex" alignItems="center" gap={1} mb={2}>
                    <WarningIcon sx={{ color: '#ff9800' }} />
                    <Typography variant="h6" fontWeight="bold" color="#e0e0e0">
                      C·∫£nh b√°o nhanh
                    </Typography>
                  </Box>
                  {(() => {
                    const context = getLampContext();
                    const warnings = [];
                    
                    context.lamps.forEach(l => {
                      if (l.state === 'ON') {
                        const expectedCurrent = (l.brightness / 100) * 0.068;
                        if (Math.abs(l.current - expectedCurrent) > 0.01) {
                          warnings.push({
                            icon: <WarningIcon sx={{ color: '#ff9800' }} />,
                            text: `ƒê√®n ${l.id}: D√≤ng ƒëi·ªán b·∫•t th∆∞·ªùng`,
                            severity: 'warning'
                          });
                        }
                        if (l.lux > 150 && l.brightness > 70) {
                          warnings.push({
                            icon: <TrendingUpIcon sx={{ color: '#2196f3' }} />,
                            text: `ƒê√®n ${l.id}: C√≥ th·ªÉ gi·∫£m ƒë·ªô s√°ng`,
                            severity: 'info'
                          });
                        }
                        if (parseFloat(l.energy) > 0.015) {
                          warnings.push({
                            icon: <BoltIcon sx={{ color: '#f44336' }} />,
                            text: `ƒê√®n ${l.id}: Ti√™u th·ª• cao`,
                            severity: 'error'
                          });
                        }
                      }
                    });

                    if (warnings.length === 0) {
                      return (
                        <Box display="flex" alignItems="center" gap={1} sx={{ p: 2, bgcolor: '#151a27', borderRadius: 1 }}>
                          <CheckCircleIcon sx={{ color: '#4caf50' }} />
                          <Typography variant="body2" color="#4caf50">
                            H·ªá th·ªëng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
                          </Typography>
                        </Box>
                      );
                    }

                    return (
                      <Box sx={{ maxHeight: 200, overflowY: 'auto' }}>
                        {warnings.slice(0, 5).map((w, idx) => (
                          <Box
                            key={idx}
                            display="flex"
                            alignItems="center"
                            gap={1}
                            sx={{ p: 1.5, mb: 1, bgcolor: '#151a27', borderRadius: 1 }}
                          >
                            {w.icon}
                            <Typography variant="body2" color="#e0e0e0">
                              {w.text}
                            </Typography>
                          </Box>
                        ))}
                      </Box>
                    );
                  })()}
                </CardContent>
              </Card>
            </Grid>

            <Grid item xs={12}>
              <Card sx={{ bgcolor: '#1e2538', borderRadius: 2 }}>
                <CardContent>
                  <Box display="flex" alignItems="center" gap={1} mb={2}>
                    <AttachMoneyIcon sx={{ color: '#4caf50' }} />
                    <Typography variant="h6" fontWeight="bold" color="#e0e0e0">
                      Chi ph√≠ ∆∞·ªõc t√≠nh
                    </Typography>
                  </Box>
                  <Box sx={{ p: 2, bgcolor: '#151a27', borderRadius: 1, mb: 1 }}>
                    <Typography variant="caption" color="#b0b0b0">H√¥m nay</Typography>
                    <Typography variant="h5" fontWeight="bold" color="#4caf50">
                      {(parseFloat(getLampContext().totalEnergy) * 24 * 2500).toFixed(0)} VNƒê
                    </Typography>
                  </Box>
                  <Box sx={{ p: 2, bgcolor: '#151a27', borderRadius: 1 }}>
                    <Typography variant="caption" color="#b0b0b0">Th√°ng n√†y (∆∞·ªõc t√≠nh)</Typography>
                    <Typography variant="h5" fontWeight="bold" color="#ffc107">
                      {(parseFloat(getLampContext().totalEnergy) * 24 * 30 * 2500).toFixed(0)} VNƒê
                    </Typography>
                  </Box>
                </CardContent>
              </Card>
            </Grid>
          </Grid>
        </Grid>
      </Grid>

      <style>
        {`
          @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
          }
        `}
      </style>
    </Box>
  );
};

export default MLPrediction;